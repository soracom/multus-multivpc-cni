name: Helm

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
    paths:
      - charts/**
      - .github/workflows/helm.yaml
  pull_request:
    paths:
      - charts/**
      - .github/workflows/helm.yaml
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Helm lint
        run: |
          helm lint charts/multus-multivpc-cni

  release:
    name: Release
    needs: lint
    runs-on: ubuntu-slim
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Authenticate to GHCR
        env:
          HELM_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          helm registry login ghcr.io --username "${GITHUB_ACTOR}" --password-stdin <<< "${HELM_PASSWORD}"

      - name: Derive version without v-prefix
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Package chart
        run: |
          helm package charts/multus-multivpc-cni --version "${VERSION}" --app-version "${VERSION}"

      - name: Push chart
        run: |
          helm push "multus-multivpc-cni-${VERSION}.tgz" "oci://ghcr.io/${{ github.repository_owner }}/charts"
